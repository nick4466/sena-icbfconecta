{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ titulo_form|default:"Matricular Nuevo Niño" }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0; font-family: 'Roboto', sans-serif; background-image: url("{% static 'img/fondito.jpg' %}");
      background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;
    }

    .container { max-width: 900px; margin: 40px auto; background-color: rgba(255, 255, 255, 0.95); border-radius: 14px; padding: 30px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    h1 { text-align: center; font-size: 28px; color: #7a3eb1; margin-bottom: 25px; }
    .form-section { margin-bottom: 30px; }
    .form-section h2 { font-size: 20px; color: #5e3370; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e5d5f5; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .form-grid p { margin: 0; display: flex; flex-direction: column; }
    label { font-weight: bold; margin-bottom: 6px; color: #555; font-size: 14px; }
    input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: 'Roboto', sans-serif; font-size: 15px; }
    .required-star { color: #dc3545; margin-left: 4px; font-weight: bold; }
    .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
    .btn-guardar, .btn-volver {
      text-decoration: none; color: white; padding: 10px 25px; border-radius: 8px; font-weight: bold;
      border: none; cursor: pointer; font-size: 15px;
    }
    .btn-guardar { background-color: #9B59B6; }
    .btn-guardar:hover { background-color: #8e44ad; }
    .btn-volver { background-color: #6c757d; }
    .btn-volver:hover { background-color: #5a6268; }
    .alert-info { background-color: #e0f7fa; border-left: 5px solid #00bcd4; padding: 15px; margin-bottom: 25px; border-radius: 6px; }
    .error-message { color: red; font-weight: bold; margin-bottom: 15px; background-color: #f8d7da; padding: 10px; border-radius: 6px; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  {% include 'madre/navbar_madre.html' %}

  <div class="container">
    <h1>
      {{ titulo_form|default:"Matricular Niño" }} en Hogar: 
      {% if modo_edicion %}
        {{ nino.hogar.nombre_hogar }}
      {% else %}
        {{ hogar_madre.nombre_hogar }}
      {% endif %}
    </h1>

    {% if messages %}
      {% for message in messages %}
        <div class="error-message">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {% if not modo_edicion %}
      <div class="alert-info">
        <p><strong>Nota importante:</strong> La identificación (Documento) del padre será usada como su nombre de usuario y contraseña inicial.</p>
      </div>
    {% endif %}

    <form method="POST">
      {% csrf_token %}
      <div class="form-section">
        <h2>Datos del Padre, Madre o Tutor</h2>
        <div class="form-grid">
          {% for field in padre_form %}
            <p>
              <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="required-star">*</span>{% endif %}</label>
              {{ field }}
              {% for error in field.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
            </p>
          {% endfor %}
        </div>
      </div>
      <div class="form-section">
        <h2>Datos del Niño</h2>
        <div class="form-grid">
          {% for field in nino_form %}
            <p>
              <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="required-star">*</span>{% endif %}</label>
              {% if field.name == 'fecha_nacimiento' and field.value %}
                <input type="date" name="{{ field.html_name }}" id="{{ field.id_for_label }}" value="{{ field.value|date:'Y-m-d' }}" required>
              {% else %}
                {{ field }}
              {% endif %}
              {% for error in field.errors %}<span class="error-message">{{ error }}</span>{% endfor %}
            </p>
          {% endfor %}
        </div>
      </div>
      <div class="form-actions">
        <a href="{% url 'listar_ninos' %}" class="btn-volver">Volver</a>
        <button type="submit" class="btn-guardar">
          {% if modo_edicion %}Guardar Cambios{% else %}Matricular Niño{% endif %}
        </button>
      </div>
    </form>
  </div>

  {% if not modo_edicion %}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const docInput = document.getElementById('id_padre-documento');
    if (docInput) {
      docInput.addEventListener('blur', function() {
        const documento = this.value;
        if (documento.length > 5) { // Un chequeo simple
          fetch(`{% url 'buscar_padre' %}?documento=${documento}`)
            .then(response => response.json())
            .then(data => {
              if (data.encontrado) {
                // Rellenar campos y hacerlos de solo lectura
                document.getElementById('id_padre-nombres').value = data.nombres;
                document.getElementById('id_padre-apellidos').value = data.apellidos;
                document.getElementById('id_padre-correo').value = data.correo;
                document.getElementById('id_padre-telefono').value = data.telefono;
                document.getElementById('id_padre-direccion').value = data.direccion;
                document.getElementById('id_padre-ocupacion').value = data.ocupacion;

                // Opcional: deshabilitar campos para evitar edición
                document.getElementById('id_padre-nombres').readOnly = true;
                document.getElementById('id_padre-apellidos').readOnly = true;
                document.getElementById('id_padre-correo').readOnly = true;
              } else {
                // Limpiar y habilitar campos si no se encuentra el padre
                document.getElementById('id_padre-nombres').value = '';
                document.getElementById('id_padre-apellidos').value = '';
                document.getElementById('id_padre-correo').value = '';
                
                document.getElementById('id_padre-nombres').readOnly = false;
                document.getElementById('id_padre-apellidos').readOnly = false;
                document.getElementById('id_padre-correo').readOnly = false;
              }
            });
        }
      });
    }
  });
  </script>
  {% endif %}

  <script>
    // Añade un asterisco a los campos obligatorios del formulario de Django
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
        const label = document.querySelector(`label[for="${field.id}"]`);
        if (label && !label.querySelector('.required-star')) {
          const star = document.createElement('span');
          star.className = 'required-star';
          star.textContent = '*';
          label.appendChild(star);
        }
      });
    });
  </script>
</body>
</html>
