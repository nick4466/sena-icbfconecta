<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de {{ nino.nombres }} {{ nino.apellidos }}</title>

    <style>
        @page { size: letter; margin: 25mm 25mm 30mm 25mm; }

        body {
            font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
            font-size: 10.5pt;
            color: #333;
            line-height: 1.45;
        }

        /* --- HEADER --- */
        header {
            position: fixed;
            top: -55px;
            left: 0;
            right: 0;
            height: 65px;
            border-bottom: 2px solid #cbb1df;
            padding-bottom: 10px;
        }
        header img {
            height: 65px;
            float: left;
        }
        header .header-text {
            text-align: right;
            margin-top: 6px;
        }
        header .header-text h1 {
            margin: 0;
            font-size: 20pt;
            color: #7a3eb1;
            font-weight: 600;
        }
        header .header-text h2 {
            margin: 3px 0 0 0;
            font-size: 12pt;
            color: #a291be;
        }

        /* --- INFO --- */
        .info-section {
            background-color: #fcf8ff;
            border: 1px solid #dbc7ed;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 30px;
            margin-bottom: 35px;
            font-size: 10pt;
        }
        .info-section p {
            margin: 4px 0;
        }

        /* --- TITULOS --- */
        h3 {
            font-size: 15pt;
            color: #7a3eb1;
            border-bottom: 2px solid #d7bbe8;
            padding-bottom: 6px;
            margin-top: 32px;
            margin-bottom: 22px;
            font-weight: 600;
        }

        /* --- TABLAS --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            margin-bottom: 28px;
        }
        thead th {
            background-color: #d7bbe8;
            color: #5e3370;
            padding: 10px 6px;
            border: 1px solid #c1a6d4;
            font-weight: 700;
            text-align: center;
        }
        tbody td {
            border: 1px solid #dbc7ed;
            padding: 8px 4px;
            text-align: center;
            font-size: 9pt;
            vertical-align: top;
            word-break: break-word;
            white-space: normal;
            max-width: 90px;
            overflow-wrap: break-word;
        }
        tbody tr:nth-child(even) {
            background-color: #faf4ff;
        }
        .empty-data {
            text-align: center;
            font-style: italic;
            padding: 18px 0;
            color: #777;
            background-color: #f7f2fc;
            border: 1px dashed #d4c6e6;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        /* --- DESARROLLO MENSUAL (Bloques) --- */
        .desarrollo-card {
            background: #f9f5ff;
            border: 1px solid #d7bbe8;
            border-radius: 12px;
            padding: 18px 22px;
            margin-bottom: 25px;
            box-shadow: 0 2px 6px rgba(122,62,177,0.1);
        }

        .desarrollo-header {
            border-bottom: 1px solid #e5d5f5;
            padding-bottom: 10px;
            margin-bottom: 12px;
        }
        .desarrollo-header .mes {
            font-size: 13pt;
            font-weight: 700;
            color: #5e3370;
        }
        .desarrollo-header .logro {
            font-size: 11pt;
            color: #7a3eb1;
        }

        .campo-titulo {
            font-weight: 600;
            color: #5e3370;
            margin-top: 10px;
            font-size: 10pt;
        }
        .campo-texto {
            margin: 4px 0 10px 0;
            text-align: justify;
            font-size: 9.7pt;
        }

        .lista-dimensiones {
            margin: 0 0 0 18px;
            padding: 0;
            list-style-type: disc;
            font-size: 9.6pt;
        }
        .lista-dimensiones li {
            margin-bottom: 4px;
        }

        /* --- FIRMAS --- */
        .firmas-container {
            margin-top: 90px;
        }
        .firmas-container table {
            width: 100%;
            border: none;
        }
        .firmas-container td {
            width: 50%;
            text-align: center;
            padding: 0 12px;
            border: none;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <header>
        <img src="{{ logo_url }}" alt="Logo">
        <div class="header-text">
            <h1>Reporte de Seguimiento</h1>
            <h2>{{ hogar_comunitario.nombre_hogar|default:"Nombre del Hogar Comunitario" }}</h2>
        </div>
    </header>

    <!-- INFO -->
    <div class="info-section">
        <p><strong>Nombre del niño:</strong> {{ nino.nombres }} {{ nino.apellidos }}</p>
        <p><strong>Documento:</strong> {{ nino.documento|default:"N/A" }}</p>
        <p><strong>Fecha de generación:</strong> {% now "d F Y, H:i" %}</p>
        <p><strong>Generado por:</strong> {{ usuario_generador }}</p>

        {% if fecha_inicio and fecha_fin %}
            <p><strong>Periodo del reporte:</strong> {{ fecha_inicio }} — {{ fecha_fin }}</p>
        {% else %}
            <p><strong>Periodo del reporte:</strong> Todo el historial</p>
        {% endif %}
    </div>

    <!-- SEGUIMIENTO DIARIO -->
    {% if tipo_reporte == 'ambos' or tipo_reporte == 'seguimiento' %}
        <h3>Seguimiento Diario</h3>
        {% if seguimientos %}
            <table>
            <thead>
                <tr style="font-size: 9.5pt;">
                    <th style="width: 15%;">Fecha</th>
                    <th style="width: 20%;">Planeación</th>
                    <th style="width: 15%;">Comporta- <br>miento</th> 
                    <th style="width: 13%;">E. Emocional</th>
                    <th style="width: 10%;">Valora- <br>ción</th>
                    <th style="width: 20%; text-align:left;">Observaciones</th>
                    <th style="width: 20%; text-align:left;">Evaluación Dimensiones</th>
                </tr>
            </thead>
            <tbody>
                {% for s in seguimientos %}
                    <tr>
                        <td style="word-break:break-word; white-space:normal; max-width:80px; vertical-align:top;">{{ s.fecha|date:"Y-m-d" }}</td>
                        <td style="word-break:break-word; white-space:normal; max-width:80px; vertical-align:top;">{{ s.planeacion.nombre_experiencia|default:"N/A" }}</td>
                        <td style="word-break:break-word; white-space:normal; max-width:80px; vertical-align:top;">{{ s.get_comportamiento_general_display }}</td>
                        <td style="word-break:break-word; white-space:pre-line;">{{ s.get_estado_emocional_display }}</td>
                        <td style="word-break:break-word; white-space:pre-line;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= s.valoracion %}
                                    ★
                                {% else %}
                                    <span style="color:#ccc;">★</span>
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td style="text-align:left; font-size: 9pt; word-break:break-word; white-space:pre-line; padding: 6px 4px;">{{ s.observaciones|default:"-" }}</td>
                        <td style="text-align:left; font-size: 8.5pt; line-height: 1.3; word-break:break-word; white-space:pre-line; padding: 6px 4px;">
                            {% for eval in s.evaluaciones_dimension.all %}
                                <div style="margin-bottom: 2px;"><b>{{ eval.dimension.nombre }}:</b> {{ eval.get_desempeno_display }}</div>
                            {% empty %}
                                Sin evaluación.
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="empty-data">No hay seguimientos diarios registrados para este periodo.</p>
        {% endif %}
    {% endif %}

    <!-- NOVEDADES -->
    {% if tipo_reporte == 'ambos' or tipo_reporte == 'novedades' %}
        <h3>Registro de Novedades</h3>
        {% if novedades %}
            <table style="width:100%; border-collapse:collapse; table-layout:fixed;">
    <colgroup>
        <col>
        <col>
        <col>
        <col>
        <col>
        <col>
        <col style="width:22%;">
    </colgroup>
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Causa</th>
            <th>Disposición</th>
            <th>Acuerdos</th>
            <th style="word-break:break-word; white-space:pre-line; text-align:left;">Observaciones</th>
        </tr>
    </thead>
    <tbody>
        {% for n in novedades %}
            <tr>
                <td>{{ n.fecha|date:"Y-m-d" }}</td>
                <td>{{ n.get_tipo_display }}</td>
                <td>{{ n.descripcion|default:"-"|truncatewords:12 }}</td>
                <td>{{ n.causa|default:"-" }}</td>
                <td>{{ n.disposicion|default:"-" }}</td>
                <td>{{ n.acuerdos|default:"-" }}</td>
                <td style="word-break:break-word; white-space:pre-line; text-align:left;">{{ n.observaciones|default:"-" }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
        {% else %}
            <p class="empty-data">No hay novedades registradas en este periodo.</p>
        {% endif %}
    {% endif %}

    <!-- DESARROLLO MENSUAL -->
    {% if tipo_reporte == 'ambos' or tipo_reporte == 'desarrollo' %}
        <h3>Desarrollo Mensual</h3>
        {% if desarrollos %}
            {% for d in desarrollos %}
                <div class="desarrollo-card" style="margin-bottom:40px;">
                    <table style="width:100%; border:none; margin-bottom:12px; table-layout:fixed;">
                        <colgroup>
                            <col style="width:18%;">
                            <col style="width:32%;">
                            <col style="width:18%;">
                            <col style="width:32%;">
                        </colgroup>
                        <tr style="background:#f3eafd;">
                            <td class="campo-titulo">FECHA</td>
                            <td>{{ d.fecha_fin_mes|date:"F Y" }}</td>
                            <td class="campo-titulo">LOGRO</td>
                            <td>{{ d.logro_mes|default:"-" }}</td>
                        </tr>
                        <tr>
                            <td class="campo-titulo">TENDENCIA</td>
                            <td>{{ d.tendencia_valoracion|default:"-" }}</td>
                            <td class="campo-titulo">PARTICIPACIÓN</td>
                            <td>{{ d.get_participacion_frecuente_display|default:"-" }}</td>
                        </tr>
                        <tr>
                            <td class="campo-titulo">COMPORTAMIENTO</td>
                            <td style="word-break:break-word;">{{ d.get_comportamiento_frecuente_display|default:"-" }}</td>
                            <td class="campo-titulo">ASISTENCIA</td>
                            <td>{{ d.porcentaje_asistencia|default:"-" }}%</td>
                        </tr>
                    </table>
                    <div style="margin-bottom:8px; font-weight:bold; color:#5e3370; font-size:10.5pt;">Dimensiones:</div>
                    <ul style="margin: 0 0 0 22px; padding: 0; list-style-type: disc; font-size: 10pt; color:#5e3370;">
                        <li><b>Cognitiva:</b> {{ d.evaluacion_cognitiva|default:"Sin información" }}</li>
                        <li><b>Comunicativa:</b> {{ d.evaluacion_comunicativa|default:"Sin información" }}</li>
                        <li><b>Socio-afectiva:</b> {{ d.evaluacion_socio_afectiva|default:"Sin información" }}</li>
                        <li><b>Corporal:</b> {{ d.evaluacion_corporal|default:"Sin información" }}</li>
                        <li><b>Autonomía:</b> {{ d.evaluacion_autonomia|default:"Sin información" }}</li>
                    </ul>
                    <div style="margin-top:12px;">
                        <div style="margin-bottom:7px; background:#f3eafd; border-radius:6px; padding:7px 12px;">
                            <b style="color:#7a3eb1;">Fortalezas:</b><br>{{ d.fortalezas_mes|linebreaksbr|default:"-" }}
                        </div>
                        <div style="margin-bottom:7px; background:#f3eafd; border-radius:6px; padding:7px 12px;">
                            <b style="color:#7a3eb1;">Aspectos a mejorar:</b><br>{{ d.aspectos_a_mejorar|linebreaksbr|default:"-" }}
                        </div>
                        <div style="margin-bottom:7px; background:#f3eafd; border-radius:6px; padding:7px 12px;">
                            <b style="color:#7a3eb1;">Alertas:</b><br>{{ d.alertas_mes|linebreaksbr|default:"-" }}
                        </div>
                        <div style="margin-bottom:7px; background:#f3eafd; border-radius:6px; padding:7px 12px;">
                            <b style="color:#7a3eb1;">Conclusión:</b><br>{{ d.conclusion_general|linebreaksbr|default:"-" }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="empty-data">No hay registros de desarrollo para este periodo.</p>
        {% endif %}
    {% endif %}

    <!-- FIRMAS -->
    <div class="firmas-container">
        <table>
            <tr>
                <td>
                    <p style="margin:0;padding-top:50px;margin-bottom:8px;font-weight:bold;">
                        ___________________________
                    </p>
                    <p style="font-size:10pt;font-weight:600;margin:0;">
                        {{ nino.hogar.madre.usuario.nombres }} {{ nino.hogar.madre.usuario.apellidos }}
                    </p>
                    <p style="font-size:10pt;margin-top:2px;">Firma de la Madre Comunitaria</p>
                </td>

                <td>
                    <p style="margin:0;padding-top:50px;margin-bottom:8px;font-weight:bold;">
                        ___________________________
                    </p>
                    <p style="font-size:10pt;font-weight:600;margin:0;">
                        {{ nino.padre.usuario.nombres }} {{ nino.padre.usuario.apellidos }}
                    </p>
                    <p style="font-size:10pt;margin-top:2px;">Firma del Padre, Madre o Cuidador</p>
                </td>
            </tr>
        </table>
    </div>

</body>
</html>
